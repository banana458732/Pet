{% extends 'base.html' %}

{% block title %}{{ pet.id }}の詳細{% endblock %}

{% block contents %}
<h2>{{ pet.id }}の詳細</h2>

<!-- 選択された画像表示用のセクション -->
<div id="selectedImage"></div>

<!-- JavaScriptによる画像表示制御 -->
<script>
    function showSelectedImage(imageUrl) {
        const selectedImageContainer = document.getElementById('selectedImage');
        selectedImageContainer.innerHTML = '';
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = '選択された画像';
        img.style.width = '300px';
        img.style.height = 'auto';
        img.style.margin = '10px';
        selectedImageContainer.appendChild(img);
    }

    // ページ読み込み時に最初の画像を表示
    window.onload = function() {
        const firstImage = "{{ pet.images.first.image.url|default:'' }}";
        if (firstImage) {
            showSelectedImage(firstImage);
        }
    };
</script>

<!-- 画像一覧表示 -->
<div>
    {% if pet.images.count > 0 %}
        {% for pet_image in pet.images.all %}
            <img src="{{ pet_image.image.url }}" alt="{{ pet.id }}の画像" 
                 style="width:100px;height:auto;margin:10px;cursor:pointer;" 
                 onclick="showSelectedImage('{{ pet_image.image.url }}')">
        {% endfor %}
    {% else %}
        <p>画像が登録されていません。</p>
    {% endif %}
</div>

<p>年齢 : {{ pet.age }}</p>
<p>性別 : {{ pet.sex }}</p>
<p>サイズ : {{ pet.size }}</p>
<p>色 : {{ pet.color }}</p>
{% if pet.disease %}
    <p>病歴 : {{ pet.disease }}</p>
{% endif %}

{% if pet.type == '犬' %}
    <p>犬種 : {{ pet.kinds }}</p>
{% else %}
    <p>猫種 : {{ pet.kinds }}</p>
{% endif %}
<p>性格 : {{ pet.personality }}</p>

<!-- 電話番号の表示 -->
<div>
    <p>ご購入を検討中の方は以下の電話番号までご連絡ください</p>
    {% if pet.phone_number %}
        <p style="font-weight: bold; color: blue;">{{ pet.phone_number }}</p>
    {% else %}
        <p>電話番号が登録されていません。</p>
    {% endif %}
</div>

<!-- 仮契約フォームリンク -->
<div>
    <h2>仮契約について</h2>
    <p>このペットに仮契約を申し込む場合は、以下のボタンをクリックしてください。</p>

    {% if other_user_karikeiyaku %}
        <!-- 他のユーザーが仮契約中 -->
        <button class="btn btn-warning" disabled>他のユーザーが仮契約中です</button>
    {% elif user_karikeiyaku %}
        <!-- 自分が仮契約中 -->
        <a href="{% url 'karikeiyaku:form' pet.id %}" class="btn btn-primary">仮契約中</a>
    <a href="{% url 'karikeiyaku:cancel' pet.id %}" class="btn btn-danger">キャンセル</a>
    {% else %}
        <!-- 仮契約していない -->
        <a href="{% url 'karikeiyaku:form' pet.id %}" class="btn btn-success">仮契約フォームに進む</a>
    {% endif %}

</div>


<!-- コメントセクション -->
<h2>コメント</h2>
<ul>
    {% for comment in comments %}
    <li>
        <strong>{{ comment.user.username }}:
            {% if comment.user.is_superuser %}
                <span style="color: red;">[管理者]</span>
            {% endif %}
        </strong> 
        {{ comment.content }}
        <br><small>{{ comment.timestamp }}</small>
        
        <!-- 管理者のみ削除ボタンを表示 -->
        {% if user.is_superuser %}
            <form method="POST" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="comment_id" value="{{ comment.id }}">
                <button type="submit" name="delete_comment" style="color: red;">削除</button>
            </form>
        {% endif %}
    </li>
    {% empty %}
    <p>まだコメントはありません。</p>
    {% endfor %}
</ul>

<!-- コメントフォーム -->
{% if user.is_superuser %}
    <h3>管理者としてコメントを追加</h3>
    <form method="post">
        {% csrf_token %}
        <textarea id="admin_comment" name="content" required></textarea>
        <button type="submit">コメントを投稿する</button>
    </form>
{% elif user.is_authenticated %}
    <h3>コメントを追加</h3>
    <form method="post">
        {% csrf_token %}
        <textarea id="message" name="content" required></textarea>
        <button type="submit">コメントを投稿する</button>
    </form>
{% endif %}

{% endblock %}
