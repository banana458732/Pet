{% extends 'accounts/base.html' %}

{% block title %}{{ pet.id }}の詳細{% endblock %}

{% block contents %}

<div class="pet-details-container">
    <!-- 画像セクション -->
    <div class="pet-images-section">
        <!-- メイン画像セクション -->
        <div class="main-image-section">
            <div id="selectedImage" class="main-image"></div>
        </div>

        <!-- JavaScriptによる画像表示制御 -->
        <script>
            function showSelectedImage(imageUrl) {
                const selectedImageContainer = document.getElementById('selectedImage');
                selectedImageContainer.innerHTML = '';
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = '選択された画像';
                img.style.width = '100%';  // 画像を幅いっぱいに表示
                img.style.height = 'auto';
                img.style.margin = '10px';
                selectedImageContainer.appendChild(img);
            }

            // ページ読み込み時に最初の画像を表示
            window.onload = function() {
                const firstImage = "{{ pet.images.first.image.url|default:'' }}";
                if (firstImage) {
                    showSelectedImage(firstImage);
                }

                // 20文字ごとに改行を挿入する処理
                let personalityText = "{{ pet.personality|escapejs }}";  // JavaScriptに安全に渡すためにescapejsを使用
                const maxLength = 40;  // 1行あたりの最大文字数
                let formattedText = '';

                // 文字列を20文字ごとに分割して改行を挿入
                while (personalityText.length > maxLength) {
                    formattedText += personalityText.substring(0, maxLength) + '<br>';
                    personalityText = personalityText.substring(maxLength);
                }
                // 残りの文字列も追加
                formattedText += personalityText;

                // 結果をHTMLに設定 (innerHTMLでHTMLを直接挿入)
                document.getElementById('formatted-personality').innerHTML = formattedText;
            };
        </script>

        <!-- サムネイル画像セクション -->
        <div class="thumbnail-images-section">
            <div class="thumbnail-images">
                {% if pet.images.count > 0 %}
                    {% for pet_image in pet.images.all %}
                        <img src="{{ pet_image.image.url }}" alt="{{ pet.id }}の画像" 
                            style="width:100px;height:auto;margin:10px;cursor:pointer;" 
                            onclick="showSelectedImage('{{ pet_image.image.url }}')">
                    {% endfor %}
                {% else %}
                    <p>画像が登録されていません。</p>
                {% endif %}
            </div>
        </div>
    </div>

    <style>
        .karikeiyaku-section {
        display: flex; /* 子要素をflexboxで配置 */
        justify-content: center; /* 横方向の中央揃え */
        align-items: center; /* 縦方向の中央揃え */
        flex-direction: column; /* 全体のレイアウトは縦並び */
        text-align: center; /* テキスト中央揃え */
        }

        .karikeiyaku-section .btn-group {
        display: flex;
        justify-content: center; /* 横方向の中央揃え */
        align-items: center; /* 縦方向の中央揃え */
        flex-wrap: wrap; /* 必要に応じて折り返し */
        gap: 20px; /* ボタン間のスペース */
        }
        /* ボタン間の角がとがらないようにするためにborder-radiusを追加 */
        .karikeiyaku-section .btn-group .btn {
            border-radius: 5px; /* ボタンの角を丸くする */
        }
        /* 仮契約中のボタン（btn-primary）の角を丸くする */
        .karikeiyaku-section .btn-group .btn.btn-primary {
            border-radius: 5px !important; /* !importantを追加して強制的に適用 */
        }
    </style>

    <!-- 情報セクション -->
    <div class="pet-info-section">
        <table class="pet-info-table">
            <tr>
                <td><strong>年齢</strong></td>
                <td>{{ pet.age }}歳</td>
            </tr>
            <tr>
                <td><strong>性別</strong></td>
                <td>{{ pet.sex }}</td>
            </tr>
            <tr>
                <td><strong>サイズ</strong></td>
                <td>{{ pet.size }}</td>
            </tr>
            <tr>
                <td><strong>毛色</strong></td>
                <td>{{ pet.color }}</td>
            </tr>
            {% if pet.disease %}
                <tr>
                    <td><strong>病歴</strong></td>
                    <td>{{ pet.disease }}</td>
                </tr>
            {% endif %}
            <tr>
                <td><strong>品種</strong></td>
                <td>
                    {% if pet.type == '犬' %}
                        {{ pet.kinds }}
                    {% else %}
                        {{ pet.kinds }}
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>性格</strong></td>
                <td id="formatted-personality">{{ pet.personality }}</td>
            </tr>
        </table>
    </div>

    <div class="comments-section">
        <h2>コメント</h2>
        <div class="comment-container">
            <!-- コメントがある場合 -->
            {% if comments %}
                <ul>
                    {% for comment in comments %}
                    <li class="comment {% if comment.user.is_superuser %}admin-comment{% else %}user-comment{% endif %}">
                        <strong>{{ comment.user.username }}:
                            {% if comment.user.is_superuser %}
                                <span style="color: red;">[管理者]</span>
                            {% endif %}
                        </strong>
                        <div class="comment-content">
                            {{ comment.content }}
                            <br><small>{{ comment.timestamp }}</small>
                        </div>
                        
                        <!-- 管理者のみ削除ボタンを表示 -->
                        {% if user.is_superuser %}
                            <form method="POST" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="comment_id" value="{{ comment.id }}">
                                <button type="submit" class="delete-button" style="color: red;">削除</button>
                            </form>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <!-- コメントがない場合 -->
                <p>まだコメントはありません。</p>
            {% endif %}
        </div>
    </div>
    
    <!-- コメントフォーム -->
    <div class="comment-form-container">
        {% if user.is_authenticated %}
            <!-- ログインしている場合 -->
            {% if user.is_superuser %}
                <h3>管理者としてコメントを追加</h3>
                <div class="comment-form">
                    <form method="post">
                        {% csrf_token %}
                        <textarea id="admin_comment" name="content" required></textarea>
                        <button type="submit" class="submit-button">コメントを投稿する</button>
                    </form>
                </div>
            {% else %}
                <h3>コメントを追加</h3>
                <div class="comment-form">
                    <form method="post">
                        {% csrf_token %}
                        <textarea id="message" name="content" required></textarea>
                        <button type="submit" class="submit-button">コメントを投稿する</button>
                    </form>
                </div>
            {% endif %}
        {% else %}
            <!-- ログインしていない場合の表示 -->
            <p>コメントを投稿するには、ログインが必要です。<a href="{% url 'accounts:login' %}">ログイン</a>してください。</p>
        {% endif %}
    </div>
    
    <!-- 仮契約について -->
    <div class="karikeiyaku-section">
        <h2>仮契約について</h2>

        {% if user.is_authenticated %}
        <!-- ログインしている場合に表示する文 -->
        <p>このペットに仮契約を申し込む場合は、以下のボタンをクリックしてください。</p>
        {% endif %}
        
        {% if not user.is_authenticated %}
            <!-- ログインしていない場合 -->
            <p>仮契約を進めるには、ログインが必要です。<a href="{% url 'accounts:login' %}">ログイン</a>してください。</p>
        {% else %}
            {% if other_user_karikeiyaku %}
                <!-- 他のユーザーが仮契約中 -->
                <button class="btn btn-warning" disabled>他のユーザーが仮契約中です</button>
            {% elif user_karikeiyaku %}
                <!-- 自分が仮契約中 -->
                <div class="btn-group">
                    <a href="{% url 'karikeiyaku:form' pet.id %}" class="btn btn-primary">仮契約中・詳細を見る</a>
                </div>
            {% else %}
                <!-- 仮契約していない -->
                <a href="{% url 'karikeiyaku:form' pet.id %}" class="btn btn-success">仮契約フォームに進む</a>
            {% endif %}
        {% endif %}
    </div>
</div>

{% endblock %}
