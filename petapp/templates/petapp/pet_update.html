{% extends '../base.html' %}

{% block title %}{{ pet_form.instance.id }}更新{% endblock %}

{% block contents %}
<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- IDと種類は変更不可の表示 -->
    <label>ID:</label>
    <span>{{ pet_form.instance.id }}</span>
    <input type="hidden" name="id" value="{{ pet_form.instance.id }}">  <!-- idフィールドを隠しフィールドとして追加 -->
    <br>
    <label>種類 (犬/猫):</label>
    <span>{{ pet_form.instance.type }}</span>
    <br>

    <!-- サイズ -->
    <label for="{{ pet_form.size.id_for_label }}">サイズ (大型/中型/小型):</label>
    {{ pet_form.size }}
    {% if pet_form.size.errors %}
        <ul style="color: red;">
            {% for error in pet_form.size.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <br>

    <!-- 色 -->
    <label for="{{ pet_form.color.id_for_label }}">色:</label>
    {{ pet_form.color }}
    {% if pet_form.color.errors %}
        <ul style="color: red;">
            {% for error in pet_form.color.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <br>

    <!-- 年齢 -->
    <label for="{{ pet_form.age.id_for_label }}">年齢:</label>
    {{ pet_form.age }}
    {% if pet_form.age.errors %}
        <ul style="color: red;">
            {% for error in pet_form.age.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <br>

    <!-- 性別 -->
    <label>性別:</label>
    <span>{{ pet_form.instance.sex }}</span>
    <br>

    <!-- その他のフィールド -->
    <label for="{{ pet_form.kinds.id_for_label }}">種別:</label>
    {{ pet_form.kinds }}
    {% if pet_form.kinds.errors %}
        <ul style="color: red;">
            {% for error in pet_form.kinds.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <br>

    <label for="{{ pet_form.disease.id_for_label }}">病歴:</label>
    {{ pet_form.disease }}
    {% if pet_form.disease.errors %}
        <ul style="color: red;">
            {% for error in pet_form.disease.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <br>

    <label for="{{ pet_form.personality.id_for_label }}">性格:</label>
    {{ pet_form.personality }}
    {% if pet_form.personality.errors %}
        <ul style="color: red;">
            {% for error in pet_form.personality.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <br>

    <label for="{{ pet_form.phone_number.id_for_label }}">電話番号:</label>
    {{ pet_form.phone_number }}
    {% if pet_form.phone_number.errors %}
        <ul style="color: red;">
            {% for error in pet_form.phone_number.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <br>

    <h3>画像の更新</h3>
    {{ image_formset.management_form }}  <!-- 管理フォームを追加 -->

    {% if image_formset.non_field_errors %}
        <ul style="color: red;">
            {% for error in image_formset.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    {% for form in image_formset %}
        <div class="image-form">
            {% if form.instance.image %}
                <img src="{{ form.instance.image.url }}" alt="Pet Image" style="width: 150px; height: auto;">
                {{ form.id.as_hidden }}  <!-- IDを隠しフィールドで保持 -->
                
                <!-- 削除チェックボックスを表示（任意） -->
                <label for="{{ form.prefix }}-DELETE">この画像を削除</label>
                {{ form.DELETE }}  <!-- DELETEフィールド -->

                {% if form.DELETE.errors %}
                    <ul style="color: red;">
                        {% for error in form.DELETE.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}

                <p style="color: orange;">更新する画像を選択:</p>
                <input type="file" name="{{ form.image.html_name }}" id="{{ form.image.id_for_label }}">

                {% if form.image.errors %}
                    <ul style="color: red;">
                        {% for error in form.image.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% else %}
                <p>新しい画像を選択:</p>
                <input type="file" name="{{ form.image.html_name }}" id="{{ form.image.id_for_label }}">

                {% if form.image.errors %}
                    <ul style="color: red;">
                        {% for error in form.image.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endif %}
        </div>
    {% endfor %}

    <br>
    <button type="submit">更新</button>
</form>

<a href="{% url 'petapp:pet-list' %}">戻る</a>

<script type="text/javascript">
    // ページロード時に、削除と更新が両方選択されている場合の制御
    document.addEventListener("DOMContentLoaded", function() {
        let imageForms = document.querySelectorAll(".image-form");  // 画像フォームを取得

        imageForms.forEach(function(form) {
            let deleteCheckbox = form.querySelector("[name$='-DELETE']");  // 削除チェックボックス
            let imageInput = form.querySelector("input[type='file']");  // 画像入力フィールド

            // 削除チェックボックスが変更されたときの処理
            deleteCheckbox.addEventListener("change", function() {
                if (deleteCheckbox.checked) {
                    imageInput.disabled = true;  // 画像更新フィールドを無効化
                } else {
                    imageInput.disabled = false;  // 画像更新フィールドを有効化
                }
            });

            // 画像入力が変更されたときの処理
            imageInput.addEventListener("change", function() {
                if (imageInput.files.length > 0) {
                    deleteCheckbox.checked = false;  // 削除チェックボックスをオフにする
                    deleteCheckbox.disabled = true;  // 削除チェックボックスを無効化
                } else {
                    deleteCheckbox.disabled = false;  // 画像が選択されていない場合は削除チェックボックスを有効化
                }
            });
        });
    });
</script>
{% endblock %}
